' --- PLACE THIS ENTIRE BLOCK IN THE SHEET MODULE (e.g., Sheet1) ---

Private Sub Worksheet_Change(ByVal Target As Range)
    ' 1. Check if the change happened in Column F (row 2-100) or Column I (row 2-100)
    Dim monitoredRange As Range
    Set monitoredRange = Me.Range("F2:F100, I2:I100")
    
    If Intersect(Target, monitoredRange) Is Nothing Then Exit Sub
    
    ' 2. Safety: Disable events so the macro doesn't trigger itself when it colors cells
    On Error GoTo CleanUp
    Application.EnableEvents = False
    Application.ScreenUpdating = False
    
    ' 3. Process Column F -> Colors D:E
    ApplyIconSetLogic Me.Range("F2:F100"), "D", "E"
    
    ' 4. Process Column I -> Colors G:H
    ApplyIconSetLogic Me.Range("I2:I100"), "G", "H"

CleanUp:
    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub

Private Sub ApplyIconSetLogic(sourceRng As Range, colStart As String, colEnd As String)
    Dim cell As Range
    Dim minVal As Double, maxVal As Double
    Dim upperThreshold As Double, lowerThreshold As Double
    
    ' Get Min/Max for this specific column to set the "Icon Set" thresholds
    ' Using WorksheetFunction to ignore blanks/text automatically
    On Error Resume Next
    minVal = Application.WorksheetFunction.Min(sourceRng)
    maxVal = Application.WorksheetFunction.Max(sourceRng)
    On Error GoTo 0
    
    ' If range is empty or all values are the same, skip coloring logic
    If minVal = 0 And maxVal = 0 Then Exit Sub
    
    ' Excel's Default Icon Set "Percent" Rule:
    ' Green: >= 67% of the distance between Min and Max
    ' Yellow: >= 33% of the distance between Min and Max
    If minVal = maxVal Then
        upperThreshold = maxVal
        lowerThreshold = maxVal
    Else
        upperThreshold = minVal + (0.67 * (maxVal - minVal))
        lowerThreshold = minVal + (0.33 * (maxVal - minVal))
    End If
    
    ' Apply the colors row by row
    For Each cell In sourceRng
        Dim targetPair As Range
        Set targetPair = Me.Range(Me.Cells(cell.Row, colStart), Me.Cells(cell.Row, colEnd))
        
        ' Reset formatting if cell is empty
        If IsEmpty(cell.Value) Or Not IsNumeric(cell.Value) Then
            targetPair.Interior.ColorIndex = xlNone
        Else
            With targetPair.Interior
                If cell.Value >= upperThreshold Then
                    .Color = RGB(0, 176, 80)    ' Green
                ElseIf cell.Value >= lowerThreshold Then
                    .Color = RGB(255, 192, 0)   ' Yellow
                Else
                    .Color = RGB(192, 0, 0)     ' Red
                End If
            End With
        End If
    Next cell
End Sub
